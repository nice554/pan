<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>盘点系统 - 实时同步</title>
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 10px;
    overflow-x: hidden;
  }

  .container {
    max-width: 100%;
    margin: 0 auto;
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    overflow: hidden;
  }

  .header {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    padding: 20px;
    text-align: center;
  }

  .header h2 {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 5px;
  }

  .sync-status {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 10px;
    padding: 8px 15px;
    background: rgba(255,255,255,0.2);
    border-radius: 20px;
    font-size: 14px;
  }

  .sync-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #4CAF50;
    animation: pulse 2s infinite;
  }

  .sync-indicator.syncing {
    background: #FF9800;
    animation: spin 1s linear infinite;
  }

  .sync-indicator.error {
    background: #F44336;
    animation: none;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .form-section {
    padding: 20px;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
  }

  .form-group {
    margin-bottom: 15px;
  }

  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #333;
  }

  .form-group input {
    width: 100%;
    padding: 12px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.3s;
  }

  .form-group input:focus {
    outline: none;
    border-color: #4facfe;
    box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
  }

  .btn {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    width: 100%;
    margin-bottom: 10px;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
  }

  .btn:active {
    transform: translateY(0);
  }

  .btn-danger {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
  }

  .btn-danger:hover {
    box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
  }

  .data-section {
    padding: 20px;
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  .data-table th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 8px;
    text-align: left;
    font-weight: 500;
    font-size: 14px;
  }

  .data-table td {
    padding: 12px 8px;
    border-bottom: 1px solid #e9ecef;
    font-size: 14px;
  }

  .data-table tr:hover {
    background: #f8f9fa;
  }

  .editable-cell {
    cursor: pointer;
    position: relative;
    transition: background-color 0.2s;
  }

  .editable-cell:hover {
    background-color: #e3f2fd !important;
  }

  .editable-input {
    width: 100%;
    border: none;
    background: transparent;
    font-size: inherit;
    text-align: center;
    outline: none;
    padding: 4px;
    border-radius: 4px;
    background: #fff3e0;
  }

  .editable-input:focus {
    background: #fff8e1;
    box-shadow: 0 0 0 2px #ff9800;
  }

  .upc-cell {
    font-family: monospace;
    font-weight: 500;
    color: #1976d2;
  }

  .action-btn {
    background: #ff6b6b;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .action-btn:hover {
    background: #ff5252;
  }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #666;
  }

  .empty-state i {
    font-size: 48px;
    color: #ddd;
    margin-bottom: 15px;
  }

  .pull-refresh {
    text-align: center;
    padding: 20px;
    color: #666;
    font-size: 14px;
  }

  .pull-refresh.active {
    color: #4facfe;
  }

  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #4CAF50;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 1000;
    transform: translateX(100%);
    transition: transform 0.3s ease;
  }

  .toast.show {
    transform: translateX(0);
  }

  .toast.error {
    background: #F44336;
  }

  .toast.warning {
    background: #FF9800;
  }

  @media (max-width: 768px) {
    .data-table {
      font-size: 12px;
    }
    
    .data-table th,
    .data-table td {
      padding: 8px 4px;
    }
    
    .header h2 {
      font-size: 20px;
    }
    
    .form-group input {
      font-size: 16px; /* 防止iOS缩放 */
    }
  }

  @media (max-width: 480px) {
    .data-table th,
    .data-table td {
      padding: 6px 2px;
      font-size: 11px;
    }
    
    .action-btn {
      padding: 4px 8px;
      font-size: 10px;
    }
  }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>📱 盘点系统</h2>
      <p>实时同步到Google Sheets</p>
      <div class="sync-status">
        <div class="sync-indicator" id="syncIndicator"></div>
        <span id="syncStatus">已连接</span>
      </div>
    </div>

    <div class="form-section">
      <div class="form-group">
        <label for="upcInput">UPC码</label>
        <input type="text" id="upcInput" placeholder="请输入UPC码" maxlength="12">
      </div>
      <button class="btn" onclick="addRecord()">添加记录</button>
      <button class="btn btn-danger" onclick="clearAllData()">清空所有数据</button>
    </div>

    <div class="data-section">
      <div class="pull-refresh" id="pullRefresh">
        <div>下拉刷新数据</div>
      </div>
      
      <table class="data-table" id="recordTable">
        <thead>
          <tr>
            <th>UPC码</th>
            <th>型号</th>
            <th>SKU</th>
            <th>数量</th>
            <th>待修</th>
            <th>报废</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- 数据行将在这里动态生成 -->
        </tbody>
      </table>
      
      <div class="empty-state" id="emptyState" style="display: none;">
        <div>📦</div>
        <div>暂无数据</div>
        <div style="font-size: 12px; margin-top: 10px; color: #999;">
          输入UPC码开始盘点
        </div>
      </div>
    </div>
  </div>

  <!-- 数量输入模态框 -->
  <div id="qtyModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px;">
      <h3 style="margin-bottom: 20px; text-align: center;">输入数量</h3>
      <div class="form-group">
        <label>正常数量</label>
        <input type="number" id="qtyInput" min="0" value="0">
      </div>
      <div class="form-group">
        <label>待修数量</label>
        <input type="number" id="repairInput" min="0" value="0">
      </div>
      <div class="form-group">
        <label>报废数量</label>
        <input type="number" id="scrapInput" min="0" value="0">
      </div>
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn" onclick="confirmQty()" style="flex: 1;">确认</button>
        <button class="btn" onclick="cancelQty()" style="flex: 1; background: #6c757d;">取消</button>
      </div>
    </div>
  </div>

  <script>
// ====== 全局变量 ======
let records = [];
let currentUPC = '';
let currentModel = '';
let pullStartY = 0;
let pullCurrentY = 0;
let isPulling = false;

// ====== Google Apps Script 配置 ======
const SCRIPT_CONFIG = {
  scriptUrl: "https://script.google.com/macros/s/AKfycbzfhXG-0wqsigNxisER1_jA8zdGuRwTp_RMFwWu0UxFp2GpzbyqLvvzuHA8ZeXviMsK/exec", // 您的脚本URL
  sheetName: "Sheet1" // 工作表名称
};

// ====== 数据缓存 ======
let modelDB = {};
let skuDB = {};
let lastUpdateTime = 0;

// ====== 初始化 ======
document.addEventListener('DOMContentLoaded', function() {
  initializeDatabases();
  loadLocalData();
  updateTable();
  setupPullRefresh();
  setupKeyboardShortcuts();
  
  // 自动同步状态检查
  setInterval(checkSyncStatus, 30000); // 每30秒检查一次
});

// ====== 数据库初始化 ======
function initializeDatabases() {
  // 型号数据库 (UPC -> 型号)
  modelDB = {
    '800000000001': '型号A',
    '800000000002': '型号B',
    '800000000003': '型号C',
    '800000000004': '型号D',
    '800000000005': '型号E'
  };

  // SKU数据库 (型号 -> SKU)
  skuDB = {
    '型号A': 'SKU001',
    '型号B': 'SKU002',
    '型号C': 'SKU003',
    '型号D': 'SKU004',
    '型号E': 'SKU005'
  };
}

// ====== 添加记录 ======
function addRecord() {
  const upcInput = document.getElementById('upcInput');
  const upc = upcInput.value.trim();
  
  if (!upc) {
    showToast('请输入UPC码', 'warning');
    return;
  }
  
  if (upc.length !== 12) {
    showToast('UPC码必须是12位数字', 'warning');
    return;
  }
  
  // 检查是否已存在
  const existingRecord = records.find(r => r.upc === upc);
  if (existingRecord) {
    showToast('该UPC码已存在', 'warning');
    return;
  }
  
  currentUPC = upc;
  currentModel = modelDB[upc] || '未知型号';
  
  // 显示数量输入模态框
  document.getElementById('qtyModal').style.display = 'block';
  document.getElementById('qtyInput').focus();
}

// ====== 确认数量 ======
function confirmQty() {
  const qty = parseInt(document.getElementById('qtyInput').value) || 0;
  const repair = parseInt(document.getElementById('repairInput').value) || 0;
  const scrap = parseInt(document.getElementById('scrapInput').value) || 0;
  
  if (qty === 0 && repair === 0 && scrap === 0) {
    showToast('请输入至少一个数量', 'warning');
    return;
  }
  
  const model = modelDB[currentUPC] || '未知型号';
  const sku = skuDB[model] || '未知SKU';
  
  const newRecord = {
    upc: currentUPC,
    model: model,
    sku: sku,
    qty: qty,
    repair: repair,
    scrap: scrap,
    timestamp: new Date().toISOString()
  };
  
  records.push(newRecord);
  saveToLocal();
  updateTable();
  syncToSheet();
  
  // 清空输入框
  document.getElementById('upcInput').value = '';
  document.getElementById('qtyInput').value = '0';
  document.getElementById('repairInput').value = '0';
  document.getElementById('scrapInput').value = '0';
  
  // 隐藏模态框
  document.getElementById('qtyModal').style.display = 'none';
  
  showToast('记录添加成功', 'success');
}

// ====== 取消数量输入 ======
function cancelQty() {
  document.getElementById('qtyModal').style.display = 'none';
  document.getElementById('qtyInput').value = '0';
  document.getElementById('repairInput').value = '0';
  document.getElementById('scrapInput').value = '0';
}

// ====== 更新表格 ======
function updateTable() {
  const tableBody = document.getElementById('tableBody');
  const emptyState = document.getElementById('emptyState');
  
  if (records.length === 0) {
    tableBody.innerHTML = '';
    emptyState.style.display = 'block';
    return;
  }
  
  emptyState.style.display = 'none';
  
  tableBody.innerHTML = records.map(record => `
    <tr>
      <td class="upc-cell">${record.upc}</td>
      <td>${record.model}</td>
      <td>${record.sku}</td>
      <td class="editable-cell" onclick="editCell(this, 'qty', '${record.upc}')">${record.qty}</td>
      <td class="editable-cell" onclick="editCell(this, 'repair', '${record.upc}')">${record.repair}</td>
      <td class="editable-cell" onclick="editCell(this, 'scrap', '${record.upc}')">${record.scrap}</td>
      <td>
        <button class="action-btn" onclick="deleteRecord('${record.upc}')">删除</button>
      </td>
    </tr>
  `).join('');
}

// ====== 编辑单元格 ======
function editCell(cell, field, upc) {
  const currentValue = cell.textContent;
  const input = document.createElement('input');
  input.type = 'number';
  input.min = '0';
  input.value = currentValue;
  input.className = 'editable-input';
  
  cell.innerHTML = '';
  cell.appendChild(input);
  input.focus();
  input.select();
  
  const saveEdit = () => {
    const newValue = parseInt(input.value) || 0;
    cell.textContent = newValue;
    
    // 更新记录
    const record = records.find(r => r.upc === upc);
    if (record) {
      record[field] = newValue;
      saveToLocal();
      syncToSheet();
    }
  };
  
  const cancelEdit = () => {
    cell.textContent = currentValue;
  };
  
  input.addEventListener('blur', saveEdit);
  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      saveEdit();
    } else if (e.key === 'Escape') {
      cancelEdit();
    }
  });
}

// ====== 删除记录 ======
function deleteRecord(upc) {
  if (confirm('确定要删除这条记录吗？')) {
    records = records.filter(r => r.upc !== upc);
    saveToLocal();
    updateTable();
    deleteSheetRow(upc);
    showToast('记录已删除', 'success');
  }
}

// ====== 清空所有数据 ======
function clearAllData() {
  if (confirm('确定要清空所有数据吗？此操作不可恢复！')) {
    records = [];
    saveToLocal();
    updateTable();
    clearSheetData();
    showToast('所有数据已清空', 'success');
  }
}

// ====== 本地存储 ======
function saveToLocal() {
  localStorage.setItem('inventory_records', JSON.stringify(records));
}

function loadLocalData() {
  const saved = localStorage.getItem('inventory_records');
  if (saved) {
    records = JSON.parse(saved);
  }
}

// ====== Google Sheets 同步 ======
function syncToSheet() {
  updateSyncStatus('syncing', '同步中...');
  
  try {
    // 使用JSONP方式避免CORS问题
    const script = document.createElement('script');
    const callbackName = 'jsonp_callback_' + Date.now();
    
    window[callbackName] = function(response) {
      if (response.status === 'success') {
        updateSyncStatus('success', '已同步');
        lastUpdateTime = Date.now();
      } else {
        updateSyncStatus('error', '同步失败');
        showToast('同步失败: ' + (response.message || '未知错误'), 'error');
      }
      document.head.removeChild(script);
      delete window[callbackName];
    };
    
    const data = encodeURIComponent(JSON.stringify({
      action: 'update',
      data: records
    }));
    
    script.src = `${SCRIPT_CONFIG.scriptUrl}?data=${data}&callback=${callbackName}`;
    document.head.appendChild(script);
    
  } catch (error) {
    console.error('同步失败:', error);
    updateSyncStatus('error', '同步失败');
    showToast('同步失败: ' + error.message, 'error');
  }
}

function clearSheetData() {
  updateSyncStatus('syncing', '清空中...');
  
  try {
    // 使用JSONP方式避免CORS问题
    const script = document.createElement('script');
    const callbackName = 'jsonp_callback_' + Date.now();
    
    window[callbackName] = function(response) {
      if (response.status === 'success') {
        updateSyncStatus('success', '已清空');
      } else {
        updateSyncStatus('error', '清空失败');
        showToast('清空失败: ' + (response.message || '未知错误'), 'error');
      }
      document.head.removeChild(script);
      delete window[callbackName];
    };
    
    const data = encodeURIComponent(JSON.stringify({
      action: 'clear'
    }));
    
    script.src = `${SCRIPT_CONFIG.scriptUrl}?data=${data}&callback=${callbackName}`;
    document.head.appendChild(script);
    
  } catch (error) {
    console.error('清空失败:', error);
    updateSyncStatus('error', '清空失败');
    showToast('清空失败: ' + error.message, 'error');
  }
}

function deleteSheetRow(upc) {
  updateSyncStatus('syncing', '删除中...');
  
  try {
    // 使用JSONP方式避免CORS问题
    const script = document.createElement('script');
    const callbackName = 'jsonp_callback_' + Date.now();
    
    window[callbackName] = function(response) {
      if (response.status === 'success') {
        updateSyncStatus('success', '已删除');
      } else {
        updateSyncStatus('error', '删除失败');
        showToast('删除失败: ' + (response.message || '未知错误'), 'error');
      }
      document.head.removeChild(script);
      delete window[callbackName];
    };
    
    const data = encodeURIComponent(JSON.stringify({
      action: 'delete',
      upc: upc
    }));
    
    script.src = `${SCRIPT_CONFIG.scriptUrl}?data=${data}&callback=${callbackName}`;
    document.head.appendChild(script);
    
  } catch (error) {
    console.error('删除失败:', error);
    updateSyncStatus('error', '删除失败');
    showToast('删除失败: ' + error.message, 'error');
  }
}

// ====== 同步状态管理 ======
function updateSyncStatus(status, message) {
  const indicator = document.getElementById('syncIndicator');
  const statusText = document.getElementById('syncStatus');
  
  indicator.className = 'sync-indicator';
  if (status === 'syncing') {
    indicator.classList.add('syncing');
  } else if (status === 'error') {
    indicator.classList.add('error');
  }
  
  statusText.textContent = message;
}

function checkSyncStatus() {
  const timeSinceLastUpdate = Date.now() - lastUpdateTime;
  if (timeSinceLastUpdate > 60000) { // 超过1分钟
    updateSyncStatus('success', '已连接');
  }
}

// ====== 下拉刷新 ======
function setupPullRefresh() {
  const pullRefresh = document.getElementById('pullRefresh');
  let startY = 0;
  let currentY = 0;
  let isPulling = false;
  
  pullRefresh.addEventListener('touchstart', (e) => {
    startY = e.touches[0].clientY;
    isPulling = true;
  });
  
  pullRefresh.addEventListener('touchmove', (e) => {
    if (!isPulling) return;
    
    currentY = e.touches[0].clientY;
    const pullDistance = currentY - startY;
    
    if (pullDistance > 50) {
      pullRefresh.classList.add('active');
      pullRefresh.innerHTML = '<div>释放刷新</div>';
    } else {
      pullRefresh.classList.remove('active');
      pullRefresh.innerHTML = '<div>下拉刷新数据</div>';
    }
  });
  
  pullRefresh.addEventListener('touchend', () => {
    if (!isPulling) return;
    
    const pullDistance = currentY - startY;
    if (pullDistance > 50) {
      refreshData();
    }
    
    isPulling = false;
    pullRefresh.classList.remove('active');
    pullRefresh.innerHTML = '<div>下拉刷新数据</div>';
  });
}

function refreshData() {
  showToast('正在刷新数据...', 'success');
  // 这里可以添加从服务器获取最新数据的逻辑
  setTimeout(() => {
    showToast('数据已刷新', 'success');
  }, 1000);
}

// ====== 键盘快捷键 ======
function setupKeyboardShortcuts() {
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.target.id === 'upcInput') {
      addRecord();
    }
  });
}

// ====== 提示消息 ======
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.add('show');
  }, 100);
  
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      document.body.removeChild(toast);
    }, 300);
  }, 3000);
}

// ====== 页面可见性变化 ======
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) {
    // 页面重新可见时检查同步状态
    checkSyncStatus();
  }
});
  </script>
</body>
</html>
