<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ç›˜ç‚¹ç³»ç»Ÿ - å®æ—¶åŒæ­¥</title>
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 10px;
    overflow-x: hidden;
  }

  .container {
    max-width: 100%;
    margin: 0 auto;
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    overflow: hidden;
  }

  .header {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    padding: 20px;
    text-align: center;
  }

  .header h2 {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 5px;
  }

  .sync-status {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 10px;
    padding: 8px 15px;
    background: rgba(255,255,255,0.2);
    border-radius: 20px;
    font-size: 14px;
  }

  .sync-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #4CAF50;
    animation: pulse 2s infinite;
  }

  .sync-indicator.syncing {
    background: #FF9800;
    animation: spin 1s linear infinite;
  }

  .sync-indicator.error {
    background: #F44336;
    animation: none;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .form-section {
    padding: 20px;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
  }

  .form-group {
    margin-bottom: 15px;
  }

  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #333;
  }

  .form-group input {
    width: 100%;
    padding: 12px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.3s;
  }

  .form-group input:focus {
    outline: none;
    border-color: #4facfe;
    box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
  }

  .btn {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    width: 100%;
    margin-bottom: 10px;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
  }

  .btn:active {
    transform: translateY(0);
  }

  .btn-danger {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
  }

  .btn-danger:hover {
    box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
  }

  .data-section {
    padding: 20px;
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  .data-table th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 8px;
    text-align: left;
    font-weight: 500;
    font-size: 14px;
  }

  .data-table td {
    padding: 12px 8px;
    border-bottom: 1px solid #e9ecef;
    font-size: 14px;
  }

  .data-table tr:hover {
    background: #f8f9fa;
  }

  .editable-cell {
    cursor: pointer;
    position: relative;
    transition: background-color 0.2s;
  }

  .editable-cell:hover {
    background-color: #e3f2fd !important;
  }

  .editable-input {
    width: 100%;
    border: none;
    background: transparent;
    font-size: inherit;
    text-align: center;
    outline: none;
    padding: 4px;
    border-radius: 4px;
    background: #fff3e0;
  }

  .editable-input:focus {
    background: #fff8e1;
    box-shadow: 0 0 0 2px #ff9800;
  }

  .upc-cell {
    font-family: monospace;
    font-weight: 500;
    color: #1976d2;
  }

  .action-btn {
    background: #ff6b6b;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .action-btn:hover {
    background: #ff5252;
  }

  /* å‹å·é€‰æ‹©ç»“æœæ ·å¼ */
  .model-result-item {
    padding: 10px 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .model-result-item:hover {
    background-color: #f8f9fa;
  }

  .model-result-item:last-child {
    border-bottom: none;
  }

  .model-info {
    flex: 1;
  }

  .model-name {
    font-weight: 600;
    color: #333;
    margin-bottom: 2px;
  }

  .model-details {
    font-size: 12px;
    color: #666;
  }

  .select-model-btn {
    background: #4facfe;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .select-model-btn:hover {
    background: #00f2fe;
  }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #666;
  }

  .empty-state i {
    font-size: 48px;
    color: #ddd;
    margin-bottom: 15px;
  }

  .pull-refresh {
    text-align: center;
    padding: 20px;
    color: #666;
    font-size: 14px;
  }

  .pull-refresh.active {
    color: #4facfe;
  }

  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #4CAF50;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 1000;
    transform: translateX(100%);
    transition: transform 0.3s ease;
  }

  .toast.show {
    transform: translateX(0);
  }

  .toast.error {
    background: #F44336;
  }

  .toast.warning {
    background: #FF9800;
  }

  /* æœç´¢é«˜äº®æ ·å¼ */
  .search-highlight {
    background: #ffeb3b;
    color: #333;
    padding: 2px 4px;
    border-radius: 3px;
    font-weight: 600;
  }

  /* æœç´¢çŠ¶æ€æŒ‡ç¤ºå™¨ */
  .search-status {
    display: inline-block;
    margin-left: 10px;
    padding: 4px 8px;
    background: #e3f2fd;
    color: #1976d2;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
  }

  /* é‡å¤UPCç æ¨¡æ€æ¡†æ ·å¼ */
  #duplicateModal table {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  #duplicateModal table th {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
    color: white;
    font-weight: 600;
  }

  #duplicateModal table td {
    transition: background-color 0.2s;
  }

  #duplicateModal table tr:hover td {
    background-color: #f8f9fa;
  }

  /* æ¨¡æ€æ¡†åŠ¨ç”» */
  #duplicateModal {
    animation: fadeIn 0.3s ease;
  }

  #duplicateModal > div {
    animation: slideIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes slideIn {
    from { 
      opacity: 0;
      transform: translate(-50%, -60%);
    }
    to { 
      opacity: 1;
      transform: translate(-50%, -50%);
    }
  }

  @media (max-width: 768px) {
    .data-table {
      font-size: 12px;
    }
    
    .data-table th,
    .data-table td {
      padding: 8px 4px;
    }
    
    .header h2 {
      font-size: 20px;
    }
    
    .form-group input {
      font-size: 16px;
    }
  }

  @media (max-width: 480px) {
    .data-table th,
    .data-table td {
      padding: 6px 2px;
      font-size: 11px;
    }
    
    .action-btn {
      padding: 4px 8px;
      font-size: 10px;
    }
  }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>ğŸ“± ç›˜ç‚¹ç³»ç»Ÿ</h2>
      <p>å®æ—¶åŒæ­¥åˆ°Google Sheets</p>
      <div class="sync-status">
        <div class="sync-indicator" id="syncIndicator"></div>
        <span id="syncStatus">å·²è¿æ¥</span>
      </div>
    </div>

    <div class="form-section">
      <div class="form-group">
        <label for="upcInput">UPCç </label>
        <input type="text" id="upcInput" placeholder="è¯·è¾“å…¥UPCç " maxlength="12">
      </div>
      <button class="btn" onclick="addRecord()">æ·»åŠ è®°å½•</button>
      
      <!-- SKUè¾“å…¥åŠŸèƒ½ -->
      <div class="form-group" style="margin-top: 20px; border-top: 1px solid #e9ecef; padding-top: 15px;">
        <label for="skuInput">SKUç </label>
        <input type="text" id="skuInput" placeholder="è¯·è¾“å…¥SKUç è¿›è¡Œå¿«é€Ÿæ·»åŠ ">
        <button class="btn" onclick="addRecordBySKU()" style="background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%); margin-top: 5px;">é€šè¿‡SKUæ·»åŠ </button>
      </div>
      
      <!-- å‹å·ç™»è®°åŠŸèƒ½ -->
      <div class="form-group" style="margin-top: 20px; border-top: 1px solid #e9ecef; padding-top: 15px;">
        <label for="modelSearchForReg">ğŸ“ å‹å·ç™»è®°</label>
        <input type="text" id="modelSearchForReg" placeholder="è¾“å…¥å‹å·éƒ¨åˆ†ä¿¡æ¯è¿›è¡Œæœç´¢">
        <button class="btn" onclick="searchModelForRegistration()" style="background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%); margin-top: 5px;">æœç´¢å‹å·</button>
      </div>
      
      <!-- å‹å·é€‰æ‹©ç»“æœ -->
      <div id="modelSearchResults" style="display: none; margin-top: 10px; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; background: white;">
        <!-- æœç´¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
      </div>
      
      <!-- æœç´¢åŠŸèƒ½ -->
      <div class="form-group" style="margin-top: 20px; border-top: 1px solid #e9ecef; padding-top: 15px;">
        <label for="searchInput">ğŸ” æ¨¡ç³Šæœç´¢æ‰€æœ‰æ•°æ®</label>
        <input type="text" id="searchInput" placeholder="è¾“å…¥UPCç ã€å‹å·ã€SKUæˆ–æ•°é‡è¿›è¡Œæœç´¢">
        <button class="btn" onclick="searchAllData()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); margin-top: 5px;">æœç´¢</button>
        <button class="btn" onclick="clearSearch()" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); margin-top: 5px;">æ¸…é™¤æœç´¢</button>
      </div>
      
      <button class="btn btn-danger" onclick="clearAllData()" style="margin-top: 10px;">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
      
      <!-- äº§å“æ•°æ®åº“æŸ¥çœ‹ -->
      <div class="form-group" style="margin-top: 20px; border-top: 1px solid #e9ecef; padding-top: 15px;">
        <label>ğŸ“‹ äº§å“æ•°æ®åº“</label>
        <button class="btn" onclick="showProductDatabase()" style="background: linear-gradient(135deg, #607d8b 0%, #455a64 100%); margin-top: 5px;">æŸ¥çœ‹æ‰€æœ‰äº§å“</button>
      </div>
    </div>

    <div class="data-section">
      <div class="pull-refresh" id="pullRefresh">
        <div>ä¸‹æ‹‰åˆ·æ–°æ•°æ®</div>
      </div>
      
      <!-- æœç´¢çŠ¶æ€æŒ‡ç¤ºå™¨ -->
      <div id="searchStatus" style="display: none; text-align: center; margin: 10px 0; padding: 8px; background: #e3f2fd; border-radius: 8px; color: #1976d2; font-size: 14px;">
        <span id="searchStatusText"></span>
        <button onclick="clearAllSearch()" style="margin-left: 10px; background: #ff6b6b; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">æ¸…é™¤</button>
      </div>
      
      <table class="data-table" id="recordTable">
        <thead>
          <tr>
            <th>UPCç </th>
            <th>å‹å·</th>
            <th>SKU</th>
            <th>æ•°é‡</th>
            <th>å¾…ä¿®</th>
            <th>æŠ¥åºŸ</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- æ•°æ®è¡Œå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </tbody>
      </table>
      
      <div class="empty-state" id="emptyState" style="display: none;">
        <div>ğŸ“¦</div>
        <div>æš‚æ— æ•°æ®</div>
        <div style="font-size: 12px; margin-top: 10px; color: #999;">
          è¾“å…¥UPCç å¼€å§‹ç›˜ç‚¹
        </div>
      </div>
    </div>
  </div>

  <!-- æ•°é‡è¾“å…¥æ¨¡æ€æ¡† -->
  <div id="qtyModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px;">
      <h3 style="margin-bottom: 20px; text-align: center;">è¾“å…¥æ•°é‡</h3>
      <div class="form-group">
        <label>æ­£å¸¸æ•°é‡</label>
        <input type="number" id="qtyInput" min="0" value="0">
      </div>
      <div class="form-group">
        <label>å¾…ä¿®æ•°é‡</label>
        <input type="number" id="repairInput" min="0" value="0">
      </div>
      <div class="form-group">
        <label>æŠ¥åºŸæ•°é‡</label>
        <input type="number" id="scrapInput" min="0" value="0">
      </div>
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn" onclick="confirmQty()" style="flex: 1;">ç¡®è®¤</button>
        <button class="btn" onclick="cancelQty()" style="flex: 1; background: #6c757d;">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- é‡å¤UPCç æ¨¡æ€æ¡† -->
  <div id="duplicateModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px;">
      <h3 style="margin-bottom: 20px; text-align: center; color: #ff6b6b;">âš ï¸ UPCç å·²å­˜åœ¨</h3>
      
      <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
        <div style="text-align: center; font-weight: 600; color: #856404;">
          è¯¥UPCç å·²å­˜åœ¨äºç›˜ç‚¹è®°å½•ä¸­
        </div>
      </div>
      
      <div style="margin-bottom: 20px;">
        <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
          <thead>
            <tr style="background: #f8f9fa;">
              <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">é¡¹ç›®</th>
              <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">ä¿¡æ¯</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="padding: 10px; border: 1px solid #ddd; font-weight: 600;">UPCç </td>
              <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace; color: #1976d2;" id="duplicateUPC"></td>
            </tr>
            <tr>
              <td style="padding: 10px; border: 1px solid #ddd; font-weight: 600;">å‹å·</td>
              <td style="padding: 10px; border: 1px solid #ddd;" id="duplicateModel"></td>
            </tr>
            <tr>
              <td style="padding: 10px; border: 1px solid #ddd; font-weight: 600;">SKU</td>
              <td style="padding: 10px; border: 1px solid #ddd;" id="duplicateSKU"></td>
            </tr>
            <tr>
              <td style="padding: 10px; border: 1px solid #ddd; font-weight: 600;">å½“å‰æ•°é‡</td>
              <td style="padding: 10px; border: 1px solid #ddd;" id="duplicateCurrentQty"></td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div style="text-align: center; margin-bottom: 20px; color: #666;">
        æ˜¯å¦è¦ä¿®æ”¹è¯¥ç‰©å“çš„æ•°é‡ï¼Ÿ
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button class="btn" onclick="modifyDuplicateQty()" style="flex: 1; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">ä¿®æ”¹æ•°é‡</button>
        <button class="btn" onclick="cancelDuplicate()" style="flex: 1; background: #6c757d;">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- äº§å“æ•°æ®åº“æ¨¡æ€æ¡† -->
  <div id="productDatabaseModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 15px; width: 95%; max-width: 800px; max-height: 80%; overflow-y: auto;">
      <h3 style="margin-bottom: 20px; text-align: center; color: #607d8b;">ğŸ“‹ äº§å“æ•°æ®åº“</h3>
      
      <div style="margin-bottom: 15px;">
        <input type="text" id="productSearchInput" placeholder="æœç´¢äº§å“åç§°ã€SKUæˆ–UPCç " style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
      </div>
      
      <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead style="position: sticky; top: 0; background: #f8f9fa;">
            <tr>
              <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-weight: 600;">UPCç </th>
              <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-weight: 600;">å‹å·</th>
              <th style="padding: 10px; border: 1px solid #ddd; text-align: left; font-weight: 600;">SKU</th>
              <th style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: 600;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="productDatabaseTableBody">
            <!-- äº§å“æ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
          </tbody>
        </table>
      </div>
      
      <div style="text-align: center; margin-top: 20px;">
        <button class="btn" onclick="closeProductDatabase()" style="background: #6c757d;">å…³é—­</button>
      </div>
    </div>
  </div>

  <script>
// ====== å…¨å±€å˜é‡ ======
let records = [];
let currentUPC = '';
let currentModel = '';
let pullStartY = 0;
let pullCurrentY = 0;
let isPulling = false;
let searchResults = [];
let isSearchMode = false;
let duplicateRecord = null;

// ====== Google Apps Script é…ç½® ======
const SCRIPT_CONFIG = {
  scriptUrl: "https://script.google.com/macros/s/AKfycbxvmwftxQad1ibgRE0Rf-nlyrfgsjQDXqDCC8U3zR4re6otNRfLePpayRpiQDot6opc/exec", // æ‚¨çš„è„šæœ¬URL
  sheetName: "Sheet1" // å·¥ä½œè¡¨åç§°
};

// ====== æ•°æ®ç¼“å­˜ ======
let modelDB = {};
let skuDB = {};
let lastUpdateTime = 0;

// ====== åˆå§‹åŒ– ======
document.addEventListener('DOMContentLoaded', function() {
  initializeDatabases();
  loadLocalData();
  updateTable();
  setupPullRefresh();
  setupKeyboardShortcuts();
  setupSearchInput();
  
  // è‡ªåŠ¨åŒæ­¥çŠ¶æ€æ£€æŸ¥
  setInterval(checkSyncStatus, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
});

// ====== æ•°æ®åº“åˆå§‹åŒ– ======
function initializeDatabases() {
  // å‹å·æ•°æ®åº“ (UPC -> å‹å·) - åŸºäºtxtæ–‡ä»¶æ•°æ®ç”Ÿæˆ
  modelDB = {
    '800000000001': 'AD900 Lite VCI',
    '800000000002': 'AB101',
    '800000000003': 'AB4000',
    '800000000004': 'AD500 è‡ªç ”',
    '800000000005': 'AD600 è‡ªç ”',
    '800000000006': 'AD600S',
    '800000000007': 'AD600S è‡ªç ”',
    '800000000008': 'AD600 Elite',
    '800000000009': 'AD600 Pro',
    '800000000010': 'AD800BT',
    '800000000011': 'AD800',
    '800000000012': 'AD900 BT',
    '800000000013': 'AL200',
    '800000000014': 'AL300',
    '800000000015': 'AL400',
    '800000000016': 'AL500',
    '800000000017': 'AL500B',
    '800000000018': 'AL600',
    '800000000019': 'AD EU',
    '800000000020': 'AD900 Lite',
    '800000000021': 'AD900BT',
    '800000000022': 'AD Pro 2.0',
    '800000000023': 'AD Pro',
    '800000000024': 'BT Mobile Lite',
    '800000000025': 'BT Mobile Pro',
    '800000000026': 'BT Mobile Pros',
    '800000000027': 'BT100',
    '800000000028': 'BT100W',
    '800000000029': 'BT20',
    '800000000030': 'BT200',
    '800000000031': 'BT30',
    '800000000032': 'BT300P',
    '800000000033': 'BT50',
    '800000000034': 'BT600',
    '800000000035': 'CarPal',
    '800000000036': 'M012',
    '800000000037': 'EC001',
    '800000000038': 'EC007(ç™½æª)',
    '800000000039': 'EC007 (é»‘æª)',
    '800000000040': 'ECP001 30A',
    '800000000041': 'ECP001 50A',
    '800000000042': 'AMP Bank H128',
    '800000000043': 'AMP Bank H128 Blue',
    '800000000044': 'H200',
    '800000000045': 'ITC629',
    '800000000046': 'JS1200',
    '800000000047': 'JS1500',
    '800000000048': 'JS2000',
    '800000000049': 'JS2000 Pro',
    '800000000050': 'JS3000',
    '800000000051': 'AMP Bank M256',
    '800000000052': 'Phoenix Nano',
    '800000000053': 'Phoenix Plus 2',
    '800000000054': 'Phoenix XLink',
    '800000000055': 'Phoenix Lite 2',
    '800000000056': 'Phoenix Smart',
    '800000000057': 'Phoenix MAX',
    '800000000058': 'Phoenix Lite 3',
    '800000000059': 'Phoenix Remote',
    '800000000060': 'Phoenix Scope',
    '800000000061': 'RLink J2534',
    '800000000062': 'RLink Lite',
    '800000000063': 'T-DARTS',
    '800000000064': 'T-Ninja Pro',
    '800000000065': 'T-Ninja Pro VCI',
    '800000000066': 'T-Ninja1000',
    '800000000067': 'T1200',
    '800000000068': 'T30A',
    '800000000069': 'T4000',
    '800000000070': 'T4000C',
    '800000000071': 'T90A',
    '800000000072': 'TB6000 Pro',
    '800000000073': 'TB8000',
    '800000000074': 'TC001',
    '800000000075': 'TC001 Plus',
    '800000000076': 'TC001(ç°)',
    '800000000077': 'TC002',
    '800000000078': 'TC002(ç«ç‘°é‡‘)',
    '800000000079': 'TC002C',
    '800000000080': 'TC002C Duo',
    '800000000081': 'TC003',
    '800000000082': 'TC004',
    '800000000083': 'TC004 Lite Black',
    '800000000084': 'TC004 Lite Blue',
    '800000000085': 'TC004 SE',
    '800000000086': 'TC004 Mini Blue',
    '800000000087': 'TC005',
    '800000000088': 'Tesla to J1772',
    '800000000089': 'Thermal Imager Holder',
    '800000000090': 'TOP KEY(FCA_BK01)',
    '800000000091': 'TOP KEY(TOYOTA_BK01)',
    '800000000092': 'TopScan Lite',
    '800000000093': 'Topscan Moto',
    '800000000094': 'Topscan Pro',
    '800000000095': 'TS001',
    '800000000096': 'TS004',
    '800000000097': 'TS006',
    '800000000098': 'TS006 Pro',
    '800000000099': 'UltraDiag',
    '800000000100': 'UltraDiag VCI',
    '800000000101': 'V1200',
    '800000000102': 'V2000 Pro',
    '800000000103': 'V2000 Pros',
    '800000000104': 'V2200',
    '800000000105': 'V2200 Plus',
    '800000000106': 'VS1200',
    '800000000107': 'VS2000',
    '800000000108': 'V2200Air',
    '800000000109': 'V4500 Plus',
    '800000000110': 'AB2000',
    '800000000111': 'AB3000',
    '800000000112': 'AP3000',
    '800000000113': 'AT001',
    '800000000114': 'AT002',
    '800000000115': 'AT003',
    '800000000116': 'AT004',
    '800000000117': 'DeepScan',
    '800000000118': 'GPSRå®‰å…¨è­¦ç¤ºæ ‡è´´',
    '800000000119': 'H128',
    '800000000120': 'H256',
    '800000000121': 'M256',
    '800000000122': 'AD800BT 2',
    '800000000123': 'M256 è“è‰²',
    '800000000124': 'M256 çº¢è‰²',
    '800000000125': 'M256 è’‚èŠ™å°¼è“',
    '800000000126': 'M256 æé¦™çº¢',
    '800000000127': 'M256 ç´«è‰²'
  };

  // SKUæ•°æ®åº“ (å‹å· -> SKU) - åŸºäºtxtæ–‡ä»¶æ•°æ®
  skuDB = {
    'AD900 Lite VCI': 'TD52110291',
    'AB101': 'TD52130054',
    'AB4000': 'TD52130223',
    'AD500 è‡ªç ”': 'TD52110362',
    'AD600 è‡ªç ”': 'TD52110363',
    'AD600S': 'TD52110228',
    'AD600S è‡ªç ”': 'TD52110361',
    'AD600 Elite': 'TD52110512',
    'AD600 Pro': 'TD52110511',
    'AD800BT': 'TD52110130',
    'AD800': 'TD52110016',
    'AD900 BT': 'TD52110509',
    'AL200': 'C11A009A01',
    'AL300': 'TD52110026',
    'AL400': 'TD52110023',
    'AL500': 'TD52110132',
    'AL500B': 'TD52110325',
    'AL600': 'TD52110326',
    'AD EU': 'TD52110481',
    'AD900 Lite': 'TD52110292',
    'AD900BT': 'TD52110509',
    'AD Pro 2.0': 'TD52110455',
    'AD Pro': 'TD52110019',
    'BT Mobile Lite': 'TD52130075',
    'BT Mobile Pro': 'TD52130044',
    'BT Mobile Pros': 'TD52130089',
    'BT100': 'TD52130053',
    'BT100W': 'TD52130090',
    'BT20': 'TD52130066',
    'BT200': 'TD52130073',
    'BT30': 'TD52130229',
    'BT300P': 'TD52130056',
    'BT50': 'TD52130055',
    'BT600': 'TD52130074',
    'CarPal': 'TD52110437',
    'M012': 'TD521C0048',
    'EC001(5m)': 'TD52130095',
    'EC001(7M)':'TD52130097',
    'EC007(ç™½æª)': 'TD60610029',
    'EC007 (é»‘æª)': 'TD60610022',
    'ECP001 30A': 'TD60630002',
    'ECP001 50A': 'TD60630003',
    'AMP Bank H128': 'AP521D0002',
    'AMP Bank H128 Blue': 'AP521D0005',
    'H200': 'C11A012A03',
    'ITC629': 'C01A047A04',
    'JS1200': 'TD52130049',
    'JS1500': 'TD52130176',
    'JS2000': 'TD52130050',
    'JS2000 Pro': 'TD52130086',
    'JS3000': 'TD52130167',
    'AMP Bank M256': 'AP521D0003',
    'Phoenix Nano': 'TD52110448',
    'Phoenix Plus 2': 'TD52110434',
    'Phoenix XLink': 'TD52110441',
    'Phoenix Lite 2': 'TD52110275',
    'Phoenix Smart': 'TD52110062',
    'Phoenix MAX': 'TD52110063',
    'Phoenix Lite 3': 'TD52110422',
    'Phoenix Remote': 'TD52110076',
    'Phoenix Scope': 'TD52110138',
    'RLink J2534': 'TD52110445',
    'RLink Lite': 'TD52110321',
    'T-DARTS': 'TD52180013',
    'T-Ninja Pro': 'TD52180028',
    'T-Ninja Pro VCI': 'TD52180016',
    'T-Ninja1000': 'TD52110004',
    'T1200': 'TD52130017',
    'T30A': 'TD52130067',
    'T4000': 'TD52130020',
    'T4000C': 'TD52130104',
    'T90A': 'TD52130061',
    'TB6000 Pro': 'TD52130091',
    'TB8000': 'TD52130057',
    'TC001': 'TD52120002',
    'TC001 Plus': 'TD521D0040',
    'TC001(ç°)': 'TD521D0005',
    'TC002': 'TD521D0027',
    'TC002(ç«ç‘°é‡‘)': 'TD521D0007',
    'TC002C': 'TD521D0041',
    'TC002C Duo': 'TD521D0081',
    'TC003': 'TD521D0022',
    'TC004': 'TD521D0021',
    'TC004 Lite Black': 'TD521D0024',
    'TC004 Lite Blue': 'TD521D0023',
    'TC004 SE': 'TD521D0067',
    'TC004 Mini Blue': 'TD521D0068',
    'TC005': 'TD521D0020',
    'Tesla to J1772': 'TD60630001',
    'Thermal Imager Holder': 'TD521C0059',
    'TOP KEY(FCA_BK01)': 'TD52180004',
    'TOP KEY(TOYOTA_BK01)': 'TD52180007',
    'TopScan Lite': 'TD52110238',
    'Topscan Moto': 'TD520E0009',
    'Topscan Pro': 'TD52110355',
    'TS001': 'TD521D0031',
    'TS004': 'TD521D0036',
    'TS006': 'TD521D0084',
    'TS006 Pro': 'TD521D0083',
    'UltraDiag': 'TD52110476',
    'UltraDiag VCI': 'TD52110244',
    'V1200': 'Z11A012A04',
    'V2000 Pro': 'TD52130024',
    'V2000 Pros': 'TD52130031',
    'V2200': 'TD52130134',
    'V2200 Plus': 'TD52130147',
    'VS1200': 'TD52130181',
    'VS2000': 'TD52130182',
    'V2200Air': 'TD52130236',
    'V4500 Plus': 'TD52130224',
    'AB2000': 'TD52130192',
    'AB3000': 'AP52130011',
    'AP3000': 'AP52130010',
    'AT001': 'AP52130003',
    'AT002': 'AP52130002',
    'AT003': 'AP52130001',
    'AT004': 'AP52130004',
    'DeepScan': 'AP52110001',
    'GPSRå®‰å…¨è­¦ç¤ºæ ‡è´´': 'AP521C0001',
    'H128': 'AP521D0002',
    'H256': 'AP521D0001',
    'M256': 'AP521D0003',
    'AD800BT 2': 'TD52110463',
    'M256 è“è‰²': 'AP521D0006',
    'M256 çº¢è‰²': 'AP521D0007',
    'M256 è’‚èŠ™å°¼è“': 'AP521D0008',
    'M256 æé¦™çº¢': 'AP521D0009',
    'M256 ç´«è‰²': 'AP521D0010'
  };
}

// ====== æ·»åŠ è®°å½• ======
function addRecord() {
  const upcInput = document.getElementById('upcInput');
  const upc = upcInput.value.trim();
  
  if (!upc) {
    showToast('è¯·è¾“å…¥UPCç ', 'warning');
    return;
  }
  
  if (upc.length !== 12) {
    showToast('UPCç å¿…é¡»æ˜¯12ä½æ•°å­—', 'warning');
    return;
  }
  
  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
  const existingRecord = records.find(r => r.upc === upc);
  if (existingRecord) {
    // æ˜¾ç¤ºé‡å¤UPCç æ¨¡æ€æ¡†
    showDuplicateModal(existingRecord);
    return;
  }
  
  currentUPC = upc;
  currentModel = modelDB[upc] || 'æœªçŸ¥å‹å·';
  
  // æ˜¾ç¤ºæ•°é‡è¾“å…¥æ¨¡æ€æ¡†
  document.getElementById('qtyModal').style.display = 'block';
  document.getElementById('qtyInput').focus();
}

// ====== é€šè¿‡SKUæ·»åŠ è®°å½• ======
function addRecordBySKU() {
  const skuInput = document.getElementById('skuInput');
  const sku = skuInput.value.trim();
  
  if (!sku) {
    showToast('è¯·è¾“å…¥SKUç ', 'warning');
    return;
  }
  
  // é€šè¿‡SKUæ‰¾åˆ°å¯¹åº”çš„å‹å·
  let foundModel = null;
  for (const [model, modelSku] of Object.entries(skuDB)) {
    if (modelSku === sku) {
      foundModel = model;
      break;
    }
  }
  
  if (!foundModel) {
    showToast('æœªæ‰¾åˆ°å¯¹åº”çš„å‹å·ï¼Œè¯·æ£€æŸ¥SKUç ', 'warning');
    return;
  }
  
  // é€šè¿‡å‹å·æ‰¾åˆ°å¯¹åº”çš„UPCç 
  let foundUPC = null;
  for (const [upc, model] of Object.entries(modelDB)) {
    if (model === foundModel) {
      foundUPC = upc;
      break;
    }
  }
  
  if (!foundUPC) {
    showToast('æœªæ‰¾åˆ°å¯¹åº”çš„UPCç ', 'warning');
    return;
  }
  
  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
  const existingRecord = records.find(r => r.upc === foundUPC);
  if (existingRecord) {
    // æ˜¾ç¤ºé‡å¤UPCç æ¨¡æ€æ¡†
    showDuplicateModal(existingRecord);
    return;
  }
  
  currentUPC = foundUPC;
  currentModel = foundModel;
  
  // æ˜¾ç¤ºæ•°é‡è¾“å…¥æ¨¡æ€æ¡†
  document.getElementById('qtyModal').style.display = 'block';
  document.getElementById('qtyInput').focus();
  
  // æ¸…ç©ºSKUè¾“å…¥æ¡†
  skuInput.value = '';
  
  showToast(`å·²æ‰¾åˆ°äº§å“: ${foundModel} (${sku})`, 'success');
}

// ====== ç¡®è®¤æ•°é‡ ======
function confirmQty() {
  const qty = parseInt(document.getElementById('qtyInput').value) || 0;
  const repair = parseInt(document.getElementById('repairInput').value) || 0;
  const scrap = parseInt(document.getElementById('scrapInput').value) || 0;
  
  if (qty === 0 && repair === 0 && scrap === 0) {
    showToast('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªæ•°é‡', 'warning');
    return;
  }
  
  const model = modelDB[currentUPC] || 'æœªçŸ¥å‹å·';
  const sku = skuDB[model] || 'æœªçŸ¥SKU';
  
  // æ£€æŸ¥æ˜¯å¦æ˜¯æ›´æ–°ç°æœ‰è®°å½•
  const existingRecordIndex = records.findIndex(r => r.upc === currentUPC);
  
  if (existingRecordIndex !== -1) {
    // æ›´æ–°ç°æœ‰è®°å½•
    records[existingRecordIndex].qty = qty;
    records[existingRecordIndex].repair = repair;
    records[existingRecordIndex].scrap = scrap;
    records[existingRecordIndex].timestamp = new Date().toISOString();
    
    showToast('è®°å½•æ›´æ–°æˆåŠŸ', 'success');
  } else {
    // æ·»åŠ æ–°è®°å½•
    const newRecord = {
      upc: currentUPC,
      model: model,
      sku: sku,
      qty: qty,
      repair: repair,
      scrap: scrap,
      timestamp: new Date().toISOString()
    };
    
    records.push(newRecord);
    showToast('è®°å½•æ·»åŠ æˆåŠŸ', 'success');
  }
  
  saveToLocal();
  updateTable();
  syncToSheet();
  
  // æ¸…ç©ºè¾“å…¥æ¡†
  document.getElementById('upcInput').value = '';
  document.getElementById('qtyInput').value = '0';
  document.getElementById('repairInput').value = '0';
  document.getElementById('scrapInput').value = '0';
  
  // éšè—æ¨¡æ€æ¡†
  document.getElementById('qtyModal').style.display = 'none';
  
  // é‡ç½®å˜é‡
  duplicateRecord = null;
  currentUPC = '';
  currentModel = '';
}

// ====== å–æ¶ˆæ•°é‡è¾“å…¥ ======
function cancelQty() {
  document.getElementById('qtyModal').style.display = 'none';
  document.getElementById('qtyInput').value = '0';
  document.getElementById('repairInput').value = '0';
  document.getElementById('scrapInput').value = '0';
  
  // é‡ç½®å˜é‡
  duplicateRecord = null;
  currentUPC = '';
  currentModel = '';
}

// ====== æ›´æ–°è¡¨æ ¼ ======
function updateTable() {
  const tableBody = document.getElementById('tableBody');
  const emptyState = document.getElementById('emptyState');
  const searchStatus = document.getElementById('searchStatus');
  const searchStatusText = document.getElementById('searchStatusText');
  
  // æ›´æ–°æœç´¢çŠ¶æ€æŒ‡ç¤ºå™¨
  if (isSearchMode) {
    const searchTerm = document.getElementById('searchInput').value.trim();
    searchStatusText.textContent = `ğŸ” æ¨¡ç³Šæœç´¢ "${searchTerm}" - æ‰¾åˆ° ${searchResults.length} æ¡è®°å½•`;
    searchStatus.style.display = 'block';
  } else {
    searchStatus.style.display = 'none';
  }
  
  // ç¡®å®šè¦æ˜¾ç¤ºçš„æ•°æ®
  const dataToShow = isSearchMode ? searchResults : records;
  
  if (dataToShow.length === 0) {
    tableBody.innerHTML = '';
    if (isSearchMode) {
      emptyState.innerHTML = `
        <div>ğŸ”</div>
        <div>æœªæ‰¾åˆ°åŒ¹é…çš„è®°å½•</div>
        <div style="font-size: 12px; margin-top: 10px; color: #999;">
          è¯·å°è¯•å…¶ä»–æœç´¢å…³é”®è¯
        </div>
      `;
    } else {
      emptyState.innerHTML = `
        <div>ğŸ“¦</div>
        <div>æš‚æ— æ•°æ®</div>
        <div style="font-size: 12px; margin-top: 10px; color: #999;">
          è¾“å…¥UPCç å¼€å§‹ç›˜ç‚¹
        </div>
      `;
    }
    emptyState.style.display = 'block';
    return;
  }
  
  emptyState.style.display = 'none';
  
  // è·å–æœç´¢å…³é”®è¯ç”¨äºé«˜äº®
  const searchTerm = isSearchMode ? document.getElementById('searchInput').value.trim().toLowerCase() : '';
  
  tableBody.innerHTML = dataToShow.map(record => {
    // é«˜äº®æœç´¢å…³é”®è¯
    const highlightText = (text, term) => {
      if (!term) return text;
      const regex = new RegExp(`(${term})`, 'gi');
      return text.replace(regex, '<mark class="search-highlight">$1</mark>');
    };
    
    return `
      <tr>
        <td class="upc-cell">${highlightText(record.upc, searchTerm)}</td>
        <td>${highlightText(record.model, searchTerm)}</td>
        <td>${highlightText(record.sku, searchTerm)}</td>
        <td class="editable-cell" onclick="editCell(this, 'qty', '${record.upc}')">${record.qty}</td>
        <td class="editable-cell" onclick="editCell(this, 'repair', '${record.upc}')">${record.repair}</td>
        <td class="editable-cell" onclick="editCell(this, 'scrap', '${record.upc}')">${record.scrap}</td>
        <td>
          <button class="action-btn" onclick="deleteRecord('${record.upc}')">åˆ é™¤</button>
        </td>
      </tr>
    `;
  }).join('');
}

// ====== ç¼–è¾‘å•å…ƒæ ¼ ======
function editCell(cell, field, upc) {
  const currentValue = cell.textContent;
  const input = document.createElement('input');
  input.type = 'number';
  input.min = '0';
  input.value = currentValue;
  input.className = 'editable-input';
  
  cell.innerHTML = '';
  cell.appendChild(input);
  input.focus();
  input.select();
  
  const saveEdit = () => {
    const newValue = parseInt(input.value) || 0;
    cell.textContent = newValue;
    
    // æ›´æ–°è®°å½•
    const record = records.find(r => r.upc === upc);
    if (record) {
      record[field] = newValue;
      saveToLocal();
      syncToSheet();
    }
  };
  
  const cancelEdit = () => {
    cell.textContent = currentValue;
  };
  
  input.addEventListener('blur', saveEdit);
  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      saveEdit();
    } else if (e.key === 'Escape') {
      cancelEdit();
    }
  });
}

// ====== åˆ é™¤è®°å½• ======
function deleteRecord(upc) {
  if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
    records = records.filter(r => r.upc !== upc);
    saveToLocal();
    updateTable();
    deleteSheetRow(upc);
    showToast('è®°å½•å·²åˆ é™¤', 'success');
  }
}

// ====== æ¸…ç©ºæ‰€æœ‰æ•°æ® ======
function clearAllData() {
  if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
    records = [];
    saveToLocal();
    updateTable();
    clearSheetData();
    showToast('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º', 'success');
  }
}

// ====== æœ¬åœ°å­˜å‚¨ ======
function saveToLocal() {
  localStorage.setItem('inventory_records', JSON.stringify(records));
}

function loadLocalData() {
  const saved = localStorage.getItem('inventory_records');
  if (saved) {
    records = JSON.parse(saved);
  }
}

// ====== Google Sheets åŒæ­¥ (JSONPæ–¹å¼) ======
function syncToSheet() {
  updateSyncStatus('syncing', 'åŒæ­¥ä¸­...');
  
  try {
    // ä½¿ç”¨JSONPæ–¹å¼é¿å…CORSé—®é¢˜
    const script = document.createElement('script');
    const callbackName = 'jsonp_callback_' + Date.now();
    
    window[callbackName] = function(response) {
      if (response.status === 'success') {
        updateSyncStatus('success', 'å·²åŒæ­¥');
        lastUpdateTime = Date.now();
      } else {
        updateSyncStatus('error', 'åŒæ­¥å¤±è´¥');
        showToast('åŒæ­¥å¤±è´¥: ' + (response.message || 'æœªçŸ¥é”™è¯¯'), 'error');
      }
      document.head.removeChild(script);
      delete window[callbackName];
    };
    
    const data = encodeURIComponent(JSON.stringify({
      action: 'update',
      data: records
    }));
    
    script.src = `${SCRIPT_CONFIG.scriptUrl}?data=${data}&callback=${callbackName}`;
    document.head.appendChild(script);
    
  } catch (error) {
    console.error('åŒæ­¥å¤±è´¥:', error);
    updateSyncStatus('error', 'åŒæ­¥å¤±è´¥');
    showToast('åŒæ­¥å¤±è´¥: ' + error.message, 'error');
  }
}

function clearSheetData() {
  updateSyncStatus('syncing', 'æ¸…ç©ºä¸­...');
  
  try {
    // ä½¿ç”¨JSONPæ–¹å¼é¿å…CORSé—®é¢˜
    const script = document.createElement('script');
    const callbackName = 'jsonp_callback_' + Date.now();
    
    window[callbackName] = function(response) {
      if (response.status === 'success') {
        updateSyncStatus('success', 'å·²æ¸…ç©º');
      } else {
        updateSyncStatus('error', 'æ¸…ç©ºå¤±è´¥');
        showToast('æ¸…ç©ºå¤±è´¥: ' + (response.message || 'æœªçŸ¥é”™è¯¯'), 'error');
      }
      document.head.removeChild(script);
      delete window[callbackName];
    };
    
    const data = encodeURIComponent(JSON.stringify({
      action: 'clear'
    }));
    
    script.src = `${SCRIPT_CONFIG.scriptUrl}?data=${data}&callback=${callbackName}`;
    document.head.appendChild(script);
    
  } catch (error) {
    console.error('æ¸…ç©ºå¤±è´¥:', error);
    updateSyncStatus('error', 'æ¸…ç©ºå¤±è´¥');
    showToast('æ¸…ç©ºå¤±è´¥: ' + error.message, 'error');
  }
}

function deleteSheetRow(upc) {
  updateSyncStatus('syncing', 'åˆ é™¤ä¸­...');
  
  try {
    // ä½¿ç”¨JSONPæ–¹å¼é¿å…CORSé—®é¢˜
    const script = document.createElement('script');
    const callbackName = 'jsonp_callback_' + Date.now();
    
    window[callbackName] = function(response) {
      if (response.status === 'success') {
        updateSyncStatus('success', 'å·²åˆ é™¤');
      } else {
        updateSyncStatus('error', 'åˆ é™¤å¤±è´¥');
        showToast('åˆ é™¤å¤±è´¥: ' + (response.message || 'æœªçŸ¥é”™è¯¯'), 'error');
      }
      document.head.removeChild(script);
      delete window[callbackName];
    };
    
    const data = encodeURIComponent(JSON.stringify({
      action: 'delete',
      upc: upc
    }));
    
    script.src = `${SCRIPT_CONFIG.scriptUrl}?data=${data}&callback=${callbackName}`;
    document.head.appendChild(script);
    
  } catch (error) {
    console.error('åˆ é™¤å¤±è´¥:', error);
    updateSyncStatus('error', 'åˆ é™¤å¤±è´¥');
    showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
  }
}

// ====== åŒæ­¥çŠ¶æ€ç®¡ç† ======
function updateSyncStatus(status, message) {
  const indicator = document.getElementById('syncIndicator');
  const statusText = document.getElementById('syncStatus');
  
  indicator.className = 'sync-indicator';
  if (status === 'syncing') {
    indicator.classList.add('syncing');
  } else if (status === 'error') {
    indicator.classList.add('error');
  }
  
  statusText.textContent = message;
}

function checkSyncStatus() {
  const timeSinceLastUpdate = Date.now() - lastUpdateTime;
  if (timeSinceLastUpdate > 60000) { // è¶…è¿‡1åˆ†é’Ÿ
    updateSyncStatus('success', 'å·²è¿æ¥');
  }
}

// ====== ä¸‹æ‹‰åˆ·æ–° ======
function setupPullRefresh() {
  const pullRefresh = document.getElementById('pullRefresh');
  let startY = 0;
  let currentY = 0;
  let isPulling = false;
  
  pullRefresh.addEventListener('touchstart', (e) => {
    startY = e.touches[0].clientY;
    isPulling = true;
  });
  
  pullRefresh.addEventListener('touchmove', (e) => {
    if (!isPulling) return;
    
    currentY = e.touches[0].clientY;
    const pullDistance = currentY - startY;
    
    if (pullDistance > 50) {
      pullRefresh.classList.add('active');
      pullRefresh.innerHTML = '<div>é‡Šæ”¾åˆ·æ–°</div>';
    } else {
      pullRefresh.classList.remove('active');
      pullRefresh.innerHTML = '<div>ä¸‹æ‹‰åˆ·æ–°æ•°æ®</div>';
    }
  });
  
  pullRefresh.addEventListener('touchend', () => {
    if (!isPulling) return;
    
    const pullDistance = currentY - startY;
    if (pullDistance > 50) {
      refreshData();
    }
    
    isPulling = false;
    pullRefresh.classList.remove('active');
    pullRefresh.innerHTML = '<div>ä¸‹æ‹‰åˆ·æ–°æ•°æ®</div>';
  });
}

function refreshData() {
  showToast('æ­£åœ¨åˆ·æ–°æ•°æ®...', 'success');
  // è¿™é‡Œå¯ä»¥æ·»åŠ ä»æœåŠ¡å™¨è·å–æœ€æ–°æ•°æ®çš„é€»è¾‘
  setTimeout(() => {
    showToast('æ•°æ®å·²åˆ·æ–°', 'success');
  }, 1000);
}

// ====== é‡å¤UPCç å¤„ç† ======
function showDuplicateModal(record) {
  duplicateRecord = record;
  
  // å¡«å……æ¨¡æ€æ¡†ä¿¡æ¯
  document.getElementById('duplicateUPC').textContent = record.upc;
  document.getElementById('duplicateModel').textContent = record.model;
  document.getElementById('duplicateSKU').textContent = record.sku;
  document.getElementById('duplicateCurrentQty').textContent = 
    `æ­£å¸¸: ${record.qty} | å¾…ä¿®: ${record.repair} | æŠ¥åºŸ: ${record.scrap}`;
  
  // æ˜¾ç¤ºæ¨¡æ€æ¡†
  document.getElementById('duplicateModal').style.display = 'block';
  
  // æ¸…ç©ºUPCè¾“å…¥æ¡†
  document.getElementById('upcInput').value = '';
}

function modifyDuplicateQty() {
  if (!duplicateRecord) return;
  
  // éšè—é‡å¤æ¨¡æ€æ¡†
  document.getElementById('duplicateModal').style.display = 'none';
  
  // è®¾ç½®å½“å‰UPCä¸ºé‡å¤è®°å½•çš„UPC
  currentUPC = duplicateRecord.upc;
  currentModel = duplicateRecord.model;
  
  // é¢„å¡«å……å½“å‰æ•°é‡
  document.getElementById('qtyInput').value = duplicateRecord.qty;
  document.getElementById('repairInput').value = duplicateRecord.repair;
  document.getElementById('scrapInput').value = duplicateRecord.scrap;
  
  // æ˜¾ç¤ºæ•°é‡è¾“å…¥æ¨¡æ€æ¡†
  document.getElementById('qtyModal').style.display = 'block';
  document.getElementById('qtyInput').focus();
  document.getElementById('qtyInput').select();
}

function cancelDuplicate() {
  // éšè—æ¨¡æ€æ¡†
  document.getElementById('duplicateModal').style.display = 'none';
  
  // æ¸…ç©ºUPCè¾“å…¥æ¡†
  document.getElementById('upcInput').value = '';
  
  // é‡ç½®å˜é‡
  duplicateRecord = null;
  currentUPC = '';
  currentModel = '';
  
  showToast('å·²å–æ¶ˆæ“ä½œ', 'success');
}

// ====== æœç´¢åŠŸèƒ½ ======
function searchAllData() {
  const searchInput = document.getElementById('searchInput');
  const searchTerm = searchInput.value.trim().toLowerCase();

  if (!searchTerm) {
    showToast('è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'warning');
    return;
  }

  if (records.length === 0) {
    showToast('æš‚æ— æ•°æ®å¯æœç´¢', 'warning');
    return;
  }

  // æ¨¡ç³Šæœç´¢æ‰€æœ‰å­—æ®µ
  searchResults = records.filter(record => {
    return record.upc.toLowerCase().includes(searchTerm) ||
           record.model.toLowerCase().includes(searchTerm) ||
           record.sku.toLowerCase().includes(searchTerm) ||
           record.qty.toString().includes(searchTerm) ||
           record.repair.toString().includes(searchTerm) ||
           record.scrap.toString().includes(searchTerm);
  });

  isSearchMode = true;
  updateTable();
  
  if (searchResults.length === 0) {
    showToast('æœªæ‰¾åˆ°åŒ¹é…çš„è®°å½•', 'warning');
  } else {
    showToast(`æ‰¾åˆ° ${searchResults.length} æ¡åŒ¹é…è®°å½•`, 'success');
  }
}

function clearSearch() {
  const searchInput = document.getElementById('searchInput');
  searchInput.value = '';
  searchResults = [];
  isSearchMode = false;
  updateTable();
  showToast('æœç´¢å·²æ¸…é™¤', 'success');
}

// ====== å‹å·ç™»è®°åŠŸèƒ½ ======
function searchModelForRegistration() {
  const modelSearchInput = document.getElementById('modelSearchForReg');
  const searchTerm = modelSearchInput.value.trim().toLowerCase();
  const resultsContainer = document.getElementById('modelSearchResults');

  if (!searchTerm) {
    showToast('è¯·è¾“å…¥å‹å·å…³é”®è¯', 'warning');
    return;
  }

  // ä»æ•°æ®åº“ä¸­æ‰¾åˆ°åŒ¹é…çš„å‹å·
  const matchingModels = [];
  
  // æœç´¢modelDBä¸­çš„å‹å·
  for (const [upc, model] of Object.entries(modelDB)) {
    if (model.toLowerCase().includes(searchTerm)) {
      const sku = skuDB[model] || 'æœªçŸ¥SKU';
      matchingModels.push({
        upc: upc,
        model: model,
        sku: sku
      });
    }
  }

  if (matchingModels.length === 0) {
    showToast('æœªæ‰¾åˆ°åŒ¹é…çš„å‹å·', 'warning');
    resultsContainer.style.display = 'none';
    return;
  }

  // æ˜¾ç¤ºæœç´¢ç»“æœ
  resultsContainer.innerHTML = matchingModels.map(item => `
    <div class="model-result-item">
      <div class="model-info">
        <div class="model-name">${item.model}</div>
        <div class="model-details">UPC: ${item.upc} | SKU: ${item.sku}</div>
      </div>
      <button class="select-model-btn" onclick="selectModelForRegistration('${item.upc}', '${item.model}', '${item.sku}')">
        é€‰æ‹©
      </button>
    </div>
  `).join('');

  resultsContainer.style.display = 'block';
  showToast(`æ‰¾åˆ° ${matchingModels.length} ä¸ªåŒ¹é…å‹å·`, 'success');
}

function selectModelForRegistration(upc, model, sku) {
  // éšè—æœç´¢ç»“æœ
  document.getElementById('modelSearchResults').style.display = 'none';
  
  // æ¸…é™¤å‹å·æœç´¢æ¡†
  document.getElementById('modelSearchForReg').value = '';
  
  // è®¾ç½®å½“å‰é€‰æ‹©çš„å‹å·ä¿¡æ¯
  currentUPC = upc;
  currentModel = model;
  
  // æ˜¾ç¤ºæ•°é‡è¾“å…¥æ¨¡æ€æ¡†
  document.getElementById('qtyModal').style.display = 'block';
  document.getElementById('qtyInput').focus();
  
  showToast(`å·²é€‰æ‹©å‹å·: ${model}`, 'success');
}

// ====== æœç´¢è¾“å…¥è®¾ç½® ======
function setupSearchInput() {
  const searchInput = document.getElementById('searchInput');
  let searchTimeout;
  
  // æœç´¢æ¡†äº‹ä»¶ç›‘å¬
  searchInput.addEventListener('input', function() {
    const searchTerm = this.value.trim();
    
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    clearTimeout(searchTimeout);
    
    if (searchTerm.length === 0) {
      // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ¸…é™¤æœç´¢
      clearSearch();
      return;
    }
    
    if (searchTerm.length < 2) {
      // è‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦æ‰å¼€å§‹æœç´¢
      return;
    }
    
    // å»¶è¿Ÿæœç´¢ï¼Œé¿å…é¢‘ç¹æœç´¢
    searchTimeout = setTimeout(() => {
      searchAllData();
    }, 300);
  });
}


// ====== é”®ç›˜å¿«æ·é”® ======
function setupKeyboardShortcuts() {
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.target.id === 'upcInput') {
      addRecord();
    } else if (e.key === 'Enter' && e.target.id === 'skuInput') {
      addRecordBySKU();
    } else if (e.key === 'Enter' && e.target.id === 'searchInput') {
      searchAllData();
    } else if (e.key === 'Enter' && e.target.id === 'modelSearchForReg') {
      searchModelForRegistration();
    }
  });
}

// ====== æç¤ºæ¶ˆæ¯ ======
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.add('show');
  }, 100);
  
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      document.body.removeChild(toast);
    }, 300);
  }, 3000);
}

// ====== äº§å“æ•°æ®åº“æŸ¥çœ‹ ======
function showProductDatabase() {
  const modal = document.getElementById('productDatabaseModal');
  const tableBody = document.getElementById('productDatabaseTableBody');
  const searchInput = document.getElementById('productSearchInput');
  
  // ç”Ÿæˆäº§å“æ•°æ®è¡¨æ ¼
  updateProductDatabaseTable();
  
  // æ˜¾ç¤ºæ¨¡æ€æ¡†
  modal.style.display = 'block';
  
  // è®¾ç½®æœç´¢åŠŸèƒ½
  searchInput.addEventListener('input', function() {
    updateProductDatabaseTable();
  });
}

function updateProductDatabaseTable() {
  const tableBody = document.getElementById('productDatabaseTableBody');
  const searchInput = document.getElementById('productSearchInput');
  const searchTerm = searchInput.value.trim().toLowerCase();
  
  let products = [];
  
  // ä»æ•°æ®åº“ç”Ÿæˆäº§å“åˆ—è¡¨
  for (const [upc, model] of Object.entries(modelDB)) {
    const sku = skuDB[model] || 'æœªçŸ¥SKU';
    products.push({ upc, model, sku });
  }
  
  // åº”ç”¨æœç´¢è¿‡æ»¤
  if (searchTerm) {
    products = products.filter(product => 
      product.upc.toLowerCase().includes(searchTerm) ||
      product.model.toLowerCase().includes(searchTerm) ||
      product.sku.toLowerCase().includes(searchTerm)
    );
  }
  
  // ç”Ÿæˆè¡¨æ ¼å†…å®¹
  tableBody.innerHTML = products.map(product => `
    <tr>
      <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace; color: #1976d2;">${product.upc}</td>
      <td style="padding: 8px; border: 1px solid #ddd;">${product.model}</td>
      <td style="padding: 8px; border: 1px solid #ddd; font-family: monospace; color: #4caf50;">${product.sku}</td>
      <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
        <button onclick="selectProductFromDatabase('${product.upc}', '${product.model}', '${product.sku}')" 
                style="background: #4facfe; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">
          é€‰æ‹©
        </button>
      </td>
    </tr>
  `).join('');
}

function selectProductFromDatabase(upc, model, sku) {
  // å…³é—­äº§å“æ•°æ®åº“æ¨¡æ€æ¡†
  closeProductDatabase();
  
  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
  const existingRecord = records.find(r => r.upc === upc);
  if (existingRecord) {
    // æ˜¾ç¤ºé‡å¤UPCç æ¨¡æ€æ¡†
    showDuplicateModal(existingRecord);
    return;
  }
  
  // è®¾ç½®å½“å‰äº§å“ä¿¡æ¯
  currentUPC = upc;
  currentModel = model;
  
  // æ˜¾ç¤ºæ•°é‡è¾“å…¥æ¨¡æ€æ¡†
  document.getElementById('qtyModal').style.display = 'block';
  document.getElementById('qtyInput').focus();
  
  showToast(`å·²é€‰æ‹©äº§å“: ${model} (${sku})`, 'success');
}

function closeProductDatabase() {
  document.getElementById('productDatabaseModal').style.display = 'none';
}

// ====== é¡µé¢å¯è§æ€§å˜åŒ– ======
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) {
    // é¡µé¢é‡æ–°å¯è§æ—¶æ£€æŸ¥åŒæ­¥çŠ¶æ€
    checkSyncStatus();
  }
});
  </script>
</body>
</html>
