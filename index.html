<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ç›˜ç‚¹ç³»ç»Ÿ</title>
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 10px;
    overflow-x: hidden;
  }

  .container {
    max-width: 100%;
    margin: 0 auto;
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    overflow: hidden;
  }

  .header {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    padding: 20px;
    text-align: center;
  }

  .header h2 {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 5px;
  }

  .sync-status {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 10px;
    padding: 8px 15px;
    background: rgba(255,255,255,0.2);
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
  }

  .sync-indicator {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .sync-status.synced {
    background: rgba(40, 167, 69, 0.3);
  }

  .sync-status.error {
    background: rgba(220, 53, 69, 0.3);
  }

  .input-section {
    padding: 20px;
    background: #f8f9fa;
  }

  .input-group {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }

  .upc-input {
    flex: 1;
    padding: 15px;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    font-size: 16px;
    transition: all 0.3s ease;
  }

  .upc-input:focus {
    outline: none;
    border-color: #4facfe;
    box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
  }

  .submit-btn {
    padding: 15px 25px;
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 80px;
  }

  .submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
  }

  .submit-btn:active {
    transform: translateY(0);
  }

  .action-buttons {
    display: flex;
    gap: 10px;
    margin-top: 15px;
  }

  .action-btn {
    flex: 1;
    padding: 12px 15px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
  }

  .export-btn {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
  }

  .clear-btn {
    background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
    color: white;
  }

  .action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  }

  .action-btn:active {
    transform: translateY(0);
  }

  .table-container {
    padding: 0 20px 20px;
    overflow-x: auto;
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  .data-table th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 10px;
    text-align: center;
    font-weight: 600;
    font-size: 14px;
  }

  .data-table td {
    padding: 12px 10px;
    text-align: center;
    border-bottom: 1px solid #e9ecef;
    font-size: 14px;
  }

  .data-table tbody tr:hover {
    background-color: #f8f9fa;
  }

  .data-table tbody tr:last-child td {
    border-bottom: none;
  }

  .editable-cell {
    cursor: pointer;
    transition: background-color 0.2s ease;
    position: relative;
  }

  .editable-cell:hover {
    background-color: #e3f2fd !important;
  }

  .editable-cell.editing {
    background-color: #fff3e0 !important;
  }

  .editable-input {
    width: 100%;
    border: none;
    background: transparent;
    text-align: center;
    font-size: inherit;
    font-weight: inherit;
    outline: none;
    padding: 0;
    margin: 0;
  }

  .upc-cell {
    background-color: #f8f9fa;
    color: #6c757d;
    font-weight: 600;
    cursor: default;
  }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #6c757d;
  }

  .empty-state i {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.5;
  }

  /* æ¨¡æ€æ¡†æ ·å¼ */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    backdrop-filter: blur(5px);
  }

  .modal-content {
    background-color: white;
    margin: 15% auto;
    padding: 0;
    border-radius: 15px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    animation: modalSlideIn 0.3s ease;
  }

  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-50px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .modal-header {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    padding: 20px;
    border-radius: 15px 15px 0 0;
    text-align: center;
  }

  .modal-body {
    padding: 30px 20px;
    text-align: center;
  }

  .modal-body h3 {
    margin-bottom: 20px;
    color: #333;
    font-size: 18px;
  }

  .qty-input {
    width: 100%;
    padding: 15px;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    font-size: 18px;
    text-align: center;
    margin-bottom: 20px;
  }

  .qty-input:focus {
    outline: none;
    border-color: #4facfe;
    box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
  }

  .modal-buttons {
    display: flex;
    gap: 10px;
  }

  .btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-primary {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
  }

  .btn-secondary {
    background: #6c757d;
    color: white;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  }

  /* æˆåŠŸæç¤º */
  .toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #28a745;
    color: white;
    padding: 12px 20px;
    border-radius: 25px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    z-index: 1001;
    animation: toastSlideIn 0.3s ease;
  }

  @keyframes toastSlideIn {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }

  /* ä¸‹æ‹‰åˆ·æ–°æŒ‡ç¤ºå™¨ */
  .pull-refresh {
    position: fixed;
    top: -60px;
    left: 0;
    right: 0;
    height: 60px;
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 600;
    transition: top 0.3s ease;
    z-index: 999;
  }

  .pull-refresh.show {
    top: 0;
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 480px) {
    .input-group {
      flex-direction: column;
    }
    
    .submit-btn {
      width: 100%;
    }
    
    .action-buttons {
      flex-direction: column;
    }
    
    .action-btn {
      width: 100%;
      margin-bottom: 5px;
    }
    
    .data-table th,
    .data-table td {
      padding: 10px 5px;
      font-size: 12px;
    }
    
    .modal-content {
      width: 95%;
      margin: 20% auto;
    }
  }

  /* é˜²æ­¢é€‰æ‹©æ–‡æœ¬ */
  .no-select {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }
</style>
</head>
<body>

<!-- ä¸‹æ‹‰åˆ·æ–°æŒ‡ç¤ºå™¨ -->
<div class="pull-refresh" id="pullRefresh">
  <span>ä¸‹æ‹‰åˆ·æ–°</span>
</div>

<div class="container">
  <div class="header">
    <h2>ğŸ“± ç›˜ç‚¹ç³»ç»Ÿ</h2>
    <p>ç§»åŠ¨ç«¯ä¼˜åŒ–ç‰ˆæœ¬</p>
    <div class="sync-status" id="syncStatus">
      <span class="sync-indicator">ğŸ”„</span>
      <span class="sync-text">åŒæ­¥ä¸­...</span>
    </div>
  </div>

  <div class="input-section">
    <div class="input-group">
      <input type="text" id="upcInput" class="upc-input" placeholder="è¾“å…¥UPCç  (12ä½, 8å¼€å¤´)" maxlength="12">
      <button onclick="processUPC()" class="submit-btn">æäº¤</button>
    </div>
    <div class="action-buttons">
      <button onclick="clearAllData()" class="action-btn clear-btn">ğŸ—‘ï¸ æ¸…ç©ºè®°å½•</button>
    </div>
  </div>

  <div class="table-container">
    <table class="data-table" id="recordTable">
      <thead>
        <tr>
          <th>UPCç </th>
          <th>å‹å·</th>
          <th>SKU</th>
          <th>æ•°é‡</th>
          <th>å¾…ä¿®</th>
          <th>æŠ¥åºŸ</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- æ•°æ®è¡Œå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
      </tbody>
    </table>
    
    <div class="empty-state" id="emptyState" style="display: none;">
      <div>ğŸ“¦</div>
      <p>æš‚æ— ç›˜ç‚¹è®°å½•</p>
      <p style="font-size: 12px; margin-top: 5px;">è¾“å…¥UPCç å¼€å§‹ç›˜ç‚¹</p>
    </div>
  </div>
</div>

<!-- æ•°é‡è¾“å…¥æ¨¡æ€æ¡† -->
<div id="qtyModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>è¾“å…¥æ•°é‡</h3>
    </div>
    <div class="modal-body">
      <h3 id="modelName">å‹å·åç§°</h3>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">æ­£å¸¸æ•°é‡:</label>
        <input type="number" id="qtyInput" class="qty-input" placeholder="è¾“å…¥æ­£å¸¸æ•°é‡" min="0" value="1">
      </div>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">å¾…ä¿®æ•°é‡:</label>
        <input type="number" id="repairInput" class="qty-input" placeholder="è¾“å…¥å¾…ä¿®æ•°é‡" min="0" value="0">
      </div>
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">æŠ¥åºŸæ•°é‡:</label>
        <input type="number" id="scrapInput" class="qty-input" placeholder="è¾“å…¥æŠ¥åºŸæ•°é‡" min="0" value="0">
      </div>
      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="confirmQty()">ç¡®è®¤</button>
      </div>
    </div>
  </div>
</div>

<script>
// ====== å…¨å±€å˜é‡ ======
let currentUPC = '';
let currentModel = '';
let pullStartY = 0;
let pullCurrentY = 0;
let isPulling = false;

// ====== Google Apps Script é…ç½® ======
const SCRIPT_CONFIG = {
  scriptUrl: "https://script.google.com/macros/s/AKfycbwrIBCVIlvD-Vj1Ue88kPwlmoJkPqXdPtcE_6VKnr71D4pms_hhJEk9ceRUn_jwtpYa/exec", // æ‚¨çš„è„šæœ¬URL
  sheetName: "Sheet1" // å·¥ä½œè¡¨åç§°
};

// ====== æ•°æ®ç¼“å­˜ ======
let modelDB = {};
let skuDB = {};
let lastUpdateTime = 0;
const CACHE_DURATION = 5 * 60 * 1000; // 5åˆ†é’Ÿç¼“å­˜

// ====== åˆå§‹åŒ–æ•°æ®åº“ ======
function initializeDatabases() {
  // æ¨¡æ‹Ÿå‹å·æ•°æ®åº“
  modelDB = {
    "800000000001": "å‹å·A",
    "800000000002": "å‹å·B", 
    "800000000003": "å‹å·C",
    "800000000004": "å‹å·D",
    "800000000005": "å‹å·E"
  };

  // æ¨¡æ‹ŸSKUæ•°æ®åº“ (é€šè¿‡å‹å·åŒ¹é…)
  skuDB = {
    "å‹å·A": "SKU001",
    "å‹å·B": "SKU002", 
    "å‹å·C": "SKU003",
    "å‹å·D": "SKU004",
    "å‹å·E": "SKU005"
  };
}

// ====== é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ– ======
document.addEventListener('DOMContentLoaded', function() {
  // åˆå§‹åŒ–æ•°æ®åº“
  initializeDatabases();
  
  // åŠ è½½æœ¬åœ°å­˜å‚¨çš„æ•°æ®
  loadLocalData();
  
  // ç»‘å®šè¾“å…¥æ¡†å›è½¦äº‹ä»¶
  document.getElementById('upcInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      processUPC();
    }
  });
  
  // ç»‘å®šä¸‹æ‹‰åˆ·æ–°äº‹ä»¶
  bindPullRefresh();
  
  // é˜²æ­¢é¡µé¢åˆ·æ–°
  preventPageRefresh();
});

// ====== å¤„ç†UPCè¾“å…¥ ======
function processUPC() {
  const upc = document.getElementById("upcInput").value.trim();

  // æ ¡éªŒUPC
  if (!/^[8]\d{11}$/.test(upc)) {
    showToast("è¯·è¾“å…¥æ­£ç¡®çš„12ä½UPCç ï¼ˆå¿…é¡»ä»¥8å¼€å¤´ï¼‰ï¼", "error");
    return;
  }

  // æŸ¥æ‰¾å‹å·
  const model = modelDB[upc] || "æœªçŸ¥å‹å·";
  currentUPC = upc;
  currentModel = model;

  // æ˜¾ç¤ºæ•°é‡è¾“å…¥æ¨¡æ€æ¡†
  showQtyModal(model);
}

// ====== æ˜¾ç¤ºæ•°é‡è¾“å…¥æ¨¡æ€æ¡† ======
function showQtyModal(model) {
  document.getElementById('modelName').textContent = model;
  document.getElementById('qtyInput').value = "1";
  document.getElementById('qtyModal').style.display = 'block';
  
  // èšç„¦åˆ°è¾“å…¥æ¡†
  setTimeout(() => {
    document.getElementById('qtyInput').focus();
    document.getElementById('qtyInput').select();
  }, 100);
}

// ====== å…³é—­æ¨¡æ€æ¡† ======
function closeModal() {
  document.getElementById('qtyModal').style.display = 'none';
  document.getElementById('upcInput').focus();
}

// ====== ç¡®è®¤æ•°é‡ ======
function confirmQty() {
  const qty = parseInt(document.getElementById('qtyInput').value) || 0;
  const repair = parseInt(document.getElementById('repairInput').value) || 0;
  const scrap = parseInt(document.getElementById('scrapInput').value) || 0;
  
  if (qty < 0 || repair < 0 || scrap < 0) {
    showToast("æ•°é‡ä¸èƒ½ä¸ºè´Ÿæ•°ï¼", "error");
    return;
  }
  
  if (qty === 0 && repair === 0 && scrap === 0) {
    showToast("è‡³å°‘éœ€è¦è¾“å…¥ä¸€ä¸ªæ•°é‡ï¼", "error");
    return;
  }

  // é€šè¿‡å‹å·è·å–SKU
  const sku = skuDB[currentModel] || "æœªçŸ¥SKU";
  
  // æ›´æ–°è¡¨æ ¼
  updateTable(currentUPC, currentModel, sku, qty, repair, scrap);
  
  // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
  saveToLocal(currentUPC, currentModel, sku, qty, repair, scrap);
  
  // åŒæ­¥åˆ°Google Sheets
  syncToSheet(currentUPC, 'all', null);
  
  // å…³é—­æ¨¡æ€æ¡†
  closeModal();
  
  // æ¸…ç©ºè¾“å…¥æ¡†
  document.getElementById('upcInput').value = "";
  
  // æ˜¾ç¤ºæˆåŠŸæç¤º
  const totalQty = qty + repair + scrap;
  showToast(`å·²æ·»åŠ  ${currentModel} æ€»è®¡${totalQty}ä»¶`, "success");
}

// ====== æ›´æ–°è¡¨æ ¼ ======
function updateTable(upc, model, sku, qty, repair, scrap) {
  const tableBody = document.getElementById('tableBody');
  const emptyState = document.getElementById('emptyState');
  
  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥UPC
  let existingRow = null;
  for (let row of tableBody.rows) {
    if (row.dataset.upc === upc) {
      existingRow = row;
      break;
    }
  }

  if (existingRow) {
    // æ›´æ–°ç°æœ‰è¡Œ
    existingRow.cells[3].innerText = qty;
    existingRow.cells[4].innerText = repair;
    existingRow.cells[5].innerText = scrap;
    showToast(`å·²æ›´æ–° ${model} æ•°é‡`, "success");
  } else {
    // æ·»åŠ æ–°è¡Œ
    const newRow = tableBody.insertRow();
    newRow.dataset.upc = upc;
    newRow.innerHTML = `
      <td class="upc-cell">${upc}</td>
      <td>${model}</td>
      <td>${sku}</td>
      <td class="editable-cell" onclick="editCell(this, 'qty', '${upc}')">${qty}</td>
      <td class="editable-cell" onclick="editCell(this, 'repair', '${upc}')">${repair}</td>
      <td class="editable-cell" onclick="editCell(this, 'scrap', '${upc}')">${scrap}</td>
      <td>
        <button onclick="deleteRow(this)" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px;">åˆ é™¤</button>
      </td>
    `;
  }
  
  // éšè—ç©ºçŠ¶æ€
  emptyState.style.display = 'none';
}

// ====== åˆ é™¤è¡Œ ======
async function deleteRow(button) {
  if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
    const row = button.closest('tr');
    const upc = row.dataset.upc;
    
    updateSyncStatus('syncing', 'åˆ é™¤ä¸­...');
    
    try {
      // ä»æœ¬åœ°å­˜å‚¨ä¸­åˆ é™¤
      removeFromLocal(upc);
      
      // ä»è¡¨æ ¼ä¸­åˆ é™¤
      row.remove();
      
      // åŒæ­¥åˆ°Google Sheets
      await deleteSheetRow(upc);
      
      // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ•°æ®
      const tableBody = document.getElementById('tableBody');
      if (tableBody.rows.length === 0) {
        document.getElementById('emptyState').style.display = 'block';
      }
      
      updateSyncStatus('synced', 'å·²åˆ é™¤');
      showToast('è®°å½•å·²åˆ é™¤', "success");
    } catch (error) {
      console.error('åˆ é™¤å¤±è´¥:', error);
      updateSyncStatus('error', 'åˆ é™¤å¤±è´¥');
      showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
  }
}

// ====== æœ¬åœ°å­˜å‚¨ç›¸å…³ ======
function saveToLocal(upc, model, sku, qty, repair, scrap) {
  let data = JSON.parse(localStorage.getItem('inventoryData') || '{}');
  data[upc] = { model, sku, qty, repair, scrap };
  localStorage.setItem('inventoryData', JSON.stringify(data));
}

function loadLocalData() {
  const data = JSON.parse(localStorage.getItem('inventoryData') || '{}');
  const tableBody = document.getElementById('tableBody');
  const emptyState = document.getElementById('emptyState');
  
  if (Object.keys(data).length === 0) {
    emptyState.style.display = 'block';
    return;
  }
  
  tableBody.innerHTML = '';
  for (const [upc, item] of Object.entries(data)) {
    const row = tableBody.insertRow();
    row.dataset.upc = upc;
    row.innerHTML = `
      <td class="upc-cell">${upc}</td>
      <td>${item.model}</td>
      <td>${item.sku || 'æœªçŸ¥SKU'}</td>
      <td class="editable-cell" onclick="editCell(this, 'qty', '${upc}')">${item.qty || 0}</td>
      <td class="editable-cell" onclick="editCell(this, 'repair', '${upc}')">${item.repair || 0}</td>
      <td class="editable-cell" onclick="editCell(this, 'scrap', '${upc}')">${item.scrap || 0}</td>
      <td>
        <button onclick="deleteRow(this)" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px;">åˆ é™¤</button>
      </td>
    `;
  }
}

function removeFromLocal(upc) {
  let data = JSON.parse(localStorage.getItem('inventoryData') || '{}');
  delete data[upc];
  localStorage.setItem('inventoryData', JSON.stringify(data));
}

// ====== ä¸‹æ‹‰åˆ·æ–°åŠŸèƒ½ ======
function bindPullRefresh() {
  let startY = 0;
  let currentY = 0;
  let isPulling = false;
  
  document.addEventListener('touchstart', function(e) {
    if (window.scrollY === 0) {
      startY = e.touches[0].clientY;
    }
  });
  
  document.addEventListener('touchmove', function(e) {
    if (window.scrollY === 0 && startY > 0) {
      currentY = e.touches[0].clientY;
      const pullDistance = currentY - startY;
      
      if (pullDistance > 0 && pullDistance < 100) {
        isPulling = true;
        document.getElementById('pullRefresh').style.top = (pullDistance - 60) + 'px';
        
        if (pullDistance > 60) {
          document.getElementById('pullRefresh').innerHTML = '<span>é‡Šæ”¾åˆ·æ–°</span>';
        } else {
          document.getElementById('pullRefresh').innerHTML = '<span>ä¸‹æ‹‰åˆ·æ–°</span>';
        }
      }
    }
  });
  
  document.addEventListener('touchend', function(e) {
    if (isPulling && window.scrollY === 0) {
      const pullDistance = currentY - startY;
      
      if (pullDistance > 60) {
        // æ‰§è¡Œåˆ·æ–°
        refreshData();
      }
      
      // é‡ç½®çŠ¶æ€
      document.getElementById('pullRefresh').style.top = '-60px';
      startY = 0;
      currentY = 0;
      isPulling = false;
    }
  });
}

// ====== åˆ·æ–°æ•°æ® ======
function refreshData() {
  showToast('æ•°æ®å·²åˆ·æ–°', "success");
  // è¿™é‡Œå¯ä»¥æ·»åŠ ä»æœåŠ¡å™¨è·å–æœ€æ–°æ•°æ®çš„é€»è¾‘
  // ç›®å‰åªæ˜¯é‡æ–°åŠ è½½æœ¬åœ°æ•°æ®
  loadLocalData();
}

// ====== é˜²æ­¢é¡µé¢åˆ·æ–° ======
function preventPageRefresh() {
  // é˜²æ­¢ä¸‹æ‹‰åˆ·æ–°
  document.addEventListener('touchstart', function(e) {
    if (e.touches.length > 1) {
      e.preventDefault();
    }
  });
  
  // é˜²æ­¢åŒå‡»ç¼©æ”¾
  let lastTouchEnd = 0;
  document.addEventListener('touchend', function(e) {
    const now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();
    }
    lastTouchEnd = now;
  }, false);
  
  // é˜²æ­¢é¡µé¢æ»šåŠ¨æ—¶çš„å¼¹æ€§æ•ˆæœ
  document.addEventListener('touchmove', function(e) {
    if (e.target.closest('.table-container')) {
      return; // å…è®¸è¡¨æ ¼æ»šåŠ¨
    }
    e.preventDefault();
  }, { passive: false });
}

// ====== æ˜¾ç¤ºæç¤ºæ¶ˆæ¯ ======
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.style.background = type === 'error' ? '#dc3545' : '#28a745';
  toast.textContent = message;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.remove();
  }, 3000);
}

// ====== æ›´æ–°åŒæ­¥çŠ¶æ€ ======
function updateSyncStatus(status, message) {
  const syncStatus = document.getElementById('syncStatus');
  const indicator = syncStatus.querySelector('.sync-indicator');
  const text = syncStatus.querySelector('.sync-text');
  
  syncStatus.className = 'sync-status';
  
  switch(status) {
    case 'syncing':
      indicator.textContent = 'ğŸ”„';
      text.textContent = message || 'åŒæ­¥ä¸­...';
      break;
    case 'synced':
      indicator.textContent = 'âœ…';
      text.textContent = message || 'å·²åŒæ­¥';
      syncStatus.classList.add('synced');
      break;
    case 'error':
      indicator.textContent = 'âŒ';
      text.textContent = message || 'åŒæ­¥å¤±è´¥';
      syncStatus.classList.add('error');
      break;
  }
}

// ====== å†…è”ç¼–è¾‘åŠŸèƒ½ ======
function editCell(cell, field, upc) {
  const currentValue = cell.textContent;
  const input = document.createElement('input');
  input.type = 'number';
  input.value = currentValue;
  input.className = 'editable-input';
  input.min = '0';
  
  cell.classList.add('editing');
  cell.innerHTML = '';
  cell.appendChild(input);
  input.focus();
  input.select();
  
  const saveEdit = () => {
    const newValue = parseInt(input.value) || 0;
    cell.textContent = newValue;
    cell.classList.remove('editing');
    
    // æ›´æ–°æœ¬åœ°æ•°æ®
    updateLocalData(upc, field, newValue);
    
    // åŒæ­¥åˆ°Google Sheets
    syncToSheet(upc, field, newValue);
  };
  
  const cancelEdit = () => {
    cell.textContent = currentValue;
    cell.classList.remove('editing');
  };
  
  input.addEventListener('blur', saveEdit);
  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      saveEdit();
    } else if (e.key === 'Escape') {
      cancelEdit();
    }
  });
}

// ====== æ›´æ–°æœ¬åœ°æ•°æ® ======
function updateLocalData(upc, field, value) {
  let data = JSON.parse(localStorage.getItem('inventoryData') || '{}');
  if (data[upc]) {
    data[upc][field] = value;
    localStorage.setItem('inventoryData', JSON.stringify(data));
  }
}

// ====== åŒæ­¥åˆ°Google Sheets ======
async function syncToSheet(upc, field, value) {
  updateSyncStatus('syncing', 'åŒæ­¥ä¸­...');
  
  try {
    // è·å–æ‰€æœ‰æœ¬åœ°æ•°æ®
    const data = JSON.parse(localStorage.getItem('inventoryData') || '{}');
    
    // å‘é€åˆ°Google Apps Script
    const response = await fetch(SCRIPT_CONFIG.scriptUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        action: 'update',
        data: data
      })
    });
    
    const result = await response.json();
    
    if (result.status === 'success') {
      updateSyncStatus('synced', 'å·²åŒæ­¥');
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    console.error('åŒæ­¥å¤±è´¥:', error);
    updateSyncStatus('error', 'åŒæ­¥å¤±è´¥');
  }
}

// ====== æ¸…ç©ºSheetæ•°æ® ======
async function clearSheetData() {
  const response = await fetch(SCRIPT_CONFIG.scriptUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      action: 'clear'
    })
  });
  
  const result = await response.json();
  
  if (result.status !== 'success') {
    throw new Error(result.message);
  }
}

// ====== åˆ é™¤Sheetä¸­çš„è¡Œ ======
async function deleteSheetRow(upc) {
  const response = await fetch(SCRIPT_CONFIG.scriptUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      action: 'delete',
      upc: upc
    })
  });
  
  const result = await response.json();
  
  if (result.status !== 'success') {
    throw new Error(result.message);
  }
}

// ====== Google Sheet æ¥å£ (ä¿ç•™åŸæœ‰åŠŸèƒ½) ======
async function sendToSheet(upc, model, sku, qty, repair, scrap) {
  const sheetId = "YOUR_SHEET_ID"; // <-- æ¢æˆä½ çš„
  const apiKey = "YOUR_API_KEY";   // <-- æ¢æˆä½ çš„

  const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/ç›˜ç‚¹!A:F:append?valueInputOption=USER_ENTERED&key=${apiKey}`;

  const body = {
    values: [[upc, model, sku, qty, repair, scrap]]
  };

  try {
    const res = await fetch(url, {
      method: "POST",
      body: JSON.stringify(body),
      headers: { "Content-Type": "application/json" }
    });
    console.log(await res.json());
  } catch (err) {
    console.error("å†™å…¥å¤±è´¥ï¼š", err);
  }
}


// ====== æ¸…ç©ºæ‰€æœ‰è®°å½•åŠŸèƒ½ ======
async function clearAllData() {
  const data = JSON.parse(localStorage.getItem('inventoryData') || '{}');
  if (Object.keys(data).length === 0) {
    showToast('æš‚æ— æ•°æ®å¯æ¸…ç©º', 'error');
    return;
  }
  
  // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
  const confirmMessage = `ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿ\n\nå½“å‰å…±æœ‰ ${Object.keys(data).length} æ¡è®°å½•\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`;
  
  if (confirm(confirmMessage)) {
    updateSyncStatus('syncing', 'æ¸…ç©ºä¸­...');
    
    try {
      // æ¸…ç©ºGoogle Sheetsæ•°æ®
      await clearSheetData();
      
      // æ¸…ç©ºæœ¬åœ°å­˜å‚¨
      localStorage.removeItem('inventoryData');
      
      // æ¸…ç©ºè¡¨æ ¼
      const tableBody = document.getElementById('tableBody');
      tableBody.innerHTML = '';
      
      // æ˜¾ç¤ºç©ºçŠ¶æ€
      document.getElementById('emptyState').style.display = 'block';
      
      updateSyncStatus('synced', 'å·²æ¸…ç©º');
      showToast('æ‰€æœ‰è®°å½•å·²æ¸…ç©º', 'success');
      
      // å¯é€‰ï¼šæ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
      setTimeout(() => {
        showToast('æ•°æ®å·²æ¸…ç©ºï¼Œå¯ä»¥å¼€å§‹æ–°çš„ç›˜ç‚¹', 'success');
      }, 1500);
    } catch (error) {
      console.error('æ¸…ç©ºå¤±è´¥:', error);
      updateSyncStatus('error', 'æ¸…ç©ºå¤±è´¥');
      showToast('æ¸…ç©ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
  }
}
</script>

</body>
</html>
